<!DOCTYPE html>
<html lang="en">
	<head>
		<script type="text/javascript">
			(function (c, l, a, r, i, t, y) {
				c[a] =
					c[a] ||
					function () {
						(c[a].q = c[a].q || []).push(arguments);
					};
				t = l.createElement(r);
				t.async = 1;
				t.src = "https://www.clarity.ms/tag/" + i;
				y = l.getElementsByTagName(r)[0];
				y.parentNode.insertBefore(t, y);
			})(window, document, "clarity", "script", "qxw0qthjku");
		</script>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, viewport-fit=cover"
		/>
		<meta name="theme-color" content="#000000" />
		<meta name="mobile-web-app-capable" content="yes" />
		<meta name="application-name" content="Aurals.LC" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta
			name="apple-mobile-web-app-status-bar-style"
			content="black-translucent"
		/>
		<meta name="apple-mobile-web-app-title" content="Aurals.LC" />
		<meta
			name="description"
			content="Free Leaving Certificate aural exam practice for French, German, Spanish, Italian and Chinese. Listen to past exam audio with interactive timestamped sections."
		/>
		<meta
			name="keywords"
			content="Leaving Certificate, LC, aural practice, French listening, German aural, Spanish exam, Italian exam, Chinese exam, language learning, LC exam prep, Irish exams"
		/>
		<meta name="robots" content="index, follow" />
		<meta
			property="og:title"
			content="Aurals.LC - Leaving Cert Language Listening Practice"
		/>
		<meta
			property="og:description"
			content="Practice for Leaving Certificate language listening exams with past papers and audio"
		/>
		<meta property="og:type" content="website" />
		<meta property="og:url" content="https://aurals.lc" />
		<meta
			property="og:image"
			content="https://aurals.lc/icons/headphones.svg"
		/>
		<meta property="og:image:alt" content="Aurals.LC logo" />
		<meta property="og:site_name" content="Aurals.LC" />
		<meta property="og:locale" content="en_IE" />

		<!-- Twitter Card data -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta
			name="twitter:title"
			content="Aurals.LC - Leaving Cert Language Listening Practice"
		/>
		<meta
			name="twitter:description"
			content="Free tool for practicing Leaving Certificate language listening exams"
		/>
		<meta
			name="twitter:image"
			content="https://aurals.lc/icons/headphones.svg"
		/>

		<link rel="canonical" href="https://aurals.lc" />
		<!-- Alternate language versions -->
		<link rel="alternate" hreflang="en-ie" href="https://aurals.lc" />
		<link rel="alternate" hreflang="fr" href="https://aurals.lc?lang=fr" />
		<link rel="alternate" hreflang="de" href="https://aurals.lc?lang=de" />
		<link rel="alternate" hreflang="es" href="https://aurals.lc?lang=es" />
		<link rel="alternate" hreflang="it" href="https://aurals.lc?lang=it" />
		<link rel="alternate" hreflang="zh" href="https://aurals.lc?lang=zh" />
		<link rel="alternate" hreflang="x-default" href="https://aurals.lc" />
		<!-- Basic favicon -->
		<link rel="icon" href="icons/headphones.svg" />

		<!-- PWA icon -->
		<link rel="apple-touch-icon" href="icons/headphones.svg" />

		<!-- iOS splash screen -->
		<link rel="apple-touch-startup-image" href="icons/headphones.svg" />

		<!-- PWA manifest -->
		<link rel="manifest" href="manifest.json" />
		<title>Aural Practice for Leaving Certificate Languages | Aurals.LC</title>
		<!-- Include Tailwind via CDN -->
		<script src="https://cdn.tailwindcss.com"></script>
		<link
			href="https://fonts.googleapis.com/css2?family=VT323&display=swap"
			rel="stylesheet"
		/>
		<!-- Structured data for rich results -->
		<script type="application/ld+json">
			{
				"@context": "https://schema.org",
				"@type": "WebApplication",
				"name": "Aurals.LC",
				"description": "Leaving Certificate language aural practice tool with French, German, Spanish, Italian and Chinese listening exams",
				"applicationCategory": "EducationalApplication",
				"url": "https://aurals.lc",
				"operatingSystem": "Web",
				"author": {
					"@type": "Person",
					"name": "aj"
				},
				"offers": {
					"@type": "Offer",
					"price": "0",
					"priceCurrency": "EUR"
				},
				"audience": {
					"@type": "EducationalAudience",
					"educationalRole": "student"
				},
				"potentialAction": {
					"@type": "UseAction",
					"target": "https://aurals.lc",
					"actionStatus": "PotentialActionStatus",
					"expectsAcceptanceOf": {
						"@type": "Offer",
						"category": "free",
						"availability": "http://schema.org/InStock"
					}
				}
			}
		</script>
		<!-- Breadcrumb structured data -->
		<script type="application/ld+json">
			{
				"@context": "https://schema.org",
				"@type": "BreadcrumbList",
				"itemListElement": [
					{
						"@type": "ListItem",
						"position": 1,
						"name": "Home",
						"item": "https://aurals.lc"
					},
					{
						"@type": "ListItem",
						"position": 2,
						"name": "Aural Practice",
						"item": "https://aurals.lc"
					}
				]
			}
		</script>

		<!-- FAQ structured data -->
		<script type="application/ld+json">
			{
				"@context": "https://schema.org",
				"@type": "FAQPage",
				"mainEntity": [
					{
						"@type": "Question",
						"name": "What is Aurals.LC?",
						"acceptedAnswer": {
							"@type": "Answer",
							"text": "Aurals.LC is a free website that helps students practice for Leaving Certificate language aural exams. It provides past exam audio with interactive timestamped sections for French, German, Spanish, Italian and Chinese."
						}
					},
					{
						"@type": "Question",
						"name": "How do I use the aural player?",
						"acceptedAnswer": {
							"@type": "Answer",
							"text": "Select your language and year from the dropdown menus. The audio player will load with colored sections corresponding to different parts of the exam. You can click on section buttons to jump to specific parts, control playback speed, and adjust volume."
						}
					},
					{
						"@type": "Question",
						"name": "What languages are available?",
						"acceptedAnswer": {
							"@type": "Answer",
							"text": "Currently, Aurals.LC offers practice materials for French, German, Spanish, Italian, and Chinese (coming soon) Leaving Certificate exams."
						}
					},
					{
						"@type": "Question",
						"name": "Are the aural papers also available?",
						"acceptedAnswer": {
							"@type": "Answer",
							"text": "Yes, for most exam years, we provide links to both the ordinary and higher level aural papers and marking schemes when available."
						}
					}
				]
			}
		</script>
		<script
			async
			src="https://www.googletagmanager.com/gtag/js?id=G-ZR3S3VRMBZ"
		></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag("js", new Date());

			gtag("config", "G-ZR3S3VRMBZ");
		</script>
	</head>
	<body
		class="flex flex-col min-h-screen m-0 p-0 font-[Poppins]"
		style="
			background: repeating-linear-gradient(
					90deg,
					white,
					white 20px,
					transparent 20px,
					transparent 22px
				),
				repeating-linear-gradient(
					0deg,
					white,
					white 20px,
					transparent 20px,
					transparent 22px
				),
				rgba(0, 0, 0, 0.3);
		"
	>
		<main>
			<div
				class="text-center text-2xl mb-4 shadow-lg bg-white border-gray-300 border-2 rounded-b-md max-w-xs border-t-0 mx-auto p-5"
			>
				<h1 class="site-heading font-extralight trakcing-wide">Aurals.LC</h1>
			</div>

			<!-- Audio Selector Dropdown -->
			<div class="flex justify-center mb-4 gap-4">
				<select
					id="languageSelector"
					class="p-2 border border-gray-300 rounded-md shadow-md"
					aria-label="Select examination language"
				>
					<!-- Will be populated dynamically -->
				</select>
				<select
					id="audioSelector"
					class="p-2 border border-gray-300 rounded-md shadow-md"
					aria-label="Select examination year"
				>
					<!-- Will be populated dynamically -->
				</select>
			</div>

			<article
				id="customPlayer"
				class="max-w-[600px] mx-auto p-5 shadow-lg bg-white border-gray-300 border-2 rounded-md"
				aria-label="Audio player for Leaving Certificate language exams"
			>
				<h2 class="sr-only">Leaving Certificate Aural Exam Player</h2>
				<!-- Hidden native audio element -->
				<audio
					id="audio"
					src="https://www.examinations.ie/archive/exampapers/2024/LC010CLP017EV.mp3"
					preload="metadata"
				></audio>

				<div class="flex flex-row mb-6">
					<div
						class="flex flex-row flex-grow items-center justify-between gap-2"
					>
						<div
							id="timeDisplay"
							class="text-center mb-1 text-xl text-gray-700"
						>
							0:00 / 0:00
						</div>
						<!-- Custom controls -->
						<div id="controls" class="justify-center items-center">
							<button
								id="playPauseBtn"
								class="text-2xl text-center cursor-pointer bg-transparent border-0 mb-[2px]"
							>
								►
							</button>
						</div>
						<div class="flex flex-row">
							<!-- Minimalistic Black Volume Slider with Speaker Icon -->
							<div
								id="volumeChanger"
								class="items-center space-x-2 mr-4 hidden sm:flex"
							>
								<!-- Speaker Icon -->
								<button id="muteBtn" class="text-black focus:outline-none">
									<img
										src="icons/volume-icon.svg"
										alt="Volume control"
										class="h-[18px] w-[18px]"
										id="muteIcon"
									/>
								</button>
								<!-- Black Styled Slider -->
								<input
									type="range"
									id="volumeSlider"
									min="0"
									max="1"
									step="0.01"
									value="1"
									class="w-24 h-1 appearance-none m-4 rounded-lg focus:outline-none"
								/>
							</div>

							<!-- Speed Changer -->
							<div
								id="speedChanger"
								class="flex items-center justify-center mb-1 space-x-2"
							>
								<span class="text-gray-700">Speed:</span>
								<select
									id="speedSelector"
									class="p-2 border border-gray-300 rounded-md shadow-sm"
								>
									<option value="0.5">0.5x</option>
									<option value="0.75">0.75x</option>
									<option value="1" selected>1x</option>
									<option value="1.25">1.25x</option>
									<option value="1.5">1.5x</option>
									<option value="2">2x</option>
								</select>
							</div>
						</div>
					</div>
				</div>

				<!-- Progress Bar with Sections -->
				<div
					id="progressContainer"
					class="relative h-[12px] bg-gray-200 cursor-pointer mb-5 rounded-md"
				>
					<div id="labelsContainer" class="relative"></div>
					<div
						id="sectionsBackground"
						class="absolute top-0 left-0 h-full w-full rounded-md overflow-hidden"
					></div>
					<div class="relative h-full w-full rounded-md overflow-hidden">
						<div
							id="progressBar"
							class="absolute top-0 left-0 h-full bg-blue-500 rounded-md w-0"
						></div>
					</div>
				</div>

				<div id="sectionsContainer" class="flex flex-wrap justify-center"></div>
				<div
					id="auralPaperContainer"
					class="flex justify-center mt-4 gap-4"
				></div>
				<div
					id="markingSchemeContainer"
					class="flex justify-center mt-4 gap-4"
				></div>
			</article>

			<div class="flex justify-center">
				<p
					class="justify-center text-center m-4 text-gray-500 p-4 mx-4 bg-white rounded-md shadow-lg border-gray-300 border-2 max-w-xs"
				>
					bugs, suggestions, and other feedback welcome at
					<a href="mailto:feedback@aurals.lc" class="font-bold"
						>feedback@aurals.lc</a
					>
				</p>
			</div>

			<section
				class="max-w-[600px] mx-auto mt-4 p-5 bg-white border-gray-300 border-2 rounded-md hidden"
			>
				<h2 class="text-xl font-bold mb-2">About Aurals.LC</h2>
				<p>
					Aurals.LC provides free practice materials for Leaving Certificate
					language aural exams. Practice with past papers in French, German,
					Spanish, Italian, and Chinese to improve your listening skills for the
					exam.
				</p>

				<h3 class="text-lg font-semibold mt-3 mb-1">Available Languages</h3>
				<ul class="list-disc pl-5">
					<li>French (2013-2024)</li>
					<li>German (2013-2024)</li>
					<li>Spanish (2013-2024)</li>
					<li>Italian (2013-2024)</li>
					<li>Chinese (Coming Soon)</li>
				</ul>

				<p class="mt-3">
					Use our interactive audio player with timestamped sections to
					effectively practice each part of the aural exam.
				</p>
			</section>
		</main>

		<footer
			class="mt-auto text-center text-gray-700 shadow-lg bg-white rounded-t-md max-w-[600px] mx-auto p-3 border-gray-300 border-2 border-b-0"
			style="padding-bottom: env(safe-area-inset-bottom)"
		>
			<p class="sm:mx-8 mb-2 flex flex-row">
				<!-- # github logo + link -->
				<a
					href="https://github.com/firesmasher231/auralsite"
					class="flex flex-row"
					target="_blank"
					rel="noopener"
					aria-label="Visit GitHub repository"
				>
					<img
						width="25px"
						height="25px"
						class="w-[25px] h-[25px]"
						src="https://img.icons8.com/ios-glyphs/360/000000/github.png"
						alt="GitHub logo"
					/>
				</a>
				&nbsp;&middot; built by&nbsp;
				<a
					href="https://adityajoshi.cc"
					class="font-bold"
					target="_blank"
					rel="noopener"
				>
					aj</a
				>
				<!-- &nbsp;&middot; inspired by&nbsp;
				<a
					href="https://www.studystrivers.ie"
					class="font-bold"
					target="_blank"
					rel="noopener"
					>studystrivers.ie</a
				> -->
				<!-- &nbsp;&middot; sponsored by&nbsp;
				<a
					href="https://instituteofeducation.ie/"
					class="font-bold"
					target="_blank"
					>ioe ❤️</a
				> -->
			</p>
		</footer>

		<script>
			const audio = document.getElementById("audio");
			const playPauseBtn = document.getElementById("playPauseBtn");
			const progressContainer = document.getElementById("progressContainer");
			const progressBar = document.getElementById("progressBar");
			const sectionsContainer = document.getElementById("sectionsContainer");
			const sectionsBackground = document.getElementById("sectionsBackground");
			const audioSelector = document.getElementById("audioSelector");
			const labelsContainer = document.getElementById("labelsContainer");
			const timeDisplay = document.getElementById("timeDisplay");

			// Global reference for the loadedmetadata listener
			let currentLoadedMetadataListener = null;
			let currentAudioLoad = null; // Track current audio load

			// Add these variables at the top with other variables
			let isDragging = false;

			// Modify the language selector population to include initial load
			fetch("languages.json")
				.then((response) => response.json())
				.then((languages) => {
					const languageSelector = document.getElementById("languageSelector");
					const audioSelector = document.getElementById("audioSelector");
					languageSelector.innerHTML = ""; // Clear existing options

					// Populate language options
					Object.entries(languages).forEach(([code, lang]) => {
						const option = document.createElement("option");
						option.value = code;
						option.textContent = lang.name;
						option.disabled = !lang.enabled;
						if (code === "fr") option.selected = true; // Default to French
						languageSelector.appendChild(option);
					});

					// Function to update year options
					function updateYearOptions(languageCode) {
						const examLinks = languages[languageCode].examLinks;
						audioSelector.innerHTML = ""; // Clear existing options

						// Get years and sort in descending order
						const years = Object.keys(examLinks).sort((a, b) => b - a);

						years.forEach((year) => {
							const option = document.createElement("option");
							option.value = year;
							option.textContent = year;
							audioSelector.appendChild(option);
						});

						// Load the first available year
						if (years.length > 0) {
							loadAudioData(years[0]);
							onAudioChange();
						}
					}

					// Initial year population for default language
					updateYearOptions(languageSelector.value);

					// Update years when language changes
					languageSelector.addEventListener("change", (e) => {
						updateYearOptions(e.target.value);
					});
				})
				.catch((err) => console.error("Error loading languages:", err));

			// Modify the loadAudioData function to fix German loading
			function loadAudioData(fileName) {
				// Cancel any existing audio load
				if (currentAudioLoad) {
					currentAudioLoad.abort(); // Abort previous fetch
					currentAudioLoad = null;
				}

				// Reset audio and UI
				audio.pause();
				audio.currentTime = 0;
				labelsContainer.innerHTML = "";
				sectionsContainer.innerHTML = `<div class="text-center text-gray-700">Loading...</div>`;
				sectionsBackground.innerHTML = "";
				progressBar.style.width = "0%";
				timeDisplay.textContent = "0:00 / 0:00";

				// Remove previous loadedmetadata listener if it exists
				if (currentLoadedMetadataListener) {
					audio.removeEventListener(
						"loadedmetadata",
						currentLoadedMetadataListener
					);
					currentLoadedMetadataListener = null;
				}

				const language = document.getElementById("languageSelector").value;

				// Create AbortController for this load
				currentAudioLoad = new AbortController();
				const signal = currentAudioLoad.signal;

				// Show loading state immediately
				sectionsContainer.innerHTML = `<div class="text-center text-gray-700">Loading...</div>`;

				// First load the timestamps
				fetch(`timestamps/${language}/${fileName}.json`, { signal })
					.then((response) => response.json())
					.then((timestampData) => {
						if (signal.aborted) return;

						// Then load the audio URL
						return fetch("languages.json", { signal })
							.then((response) => response.json())
							.then((languages) => {
								const langData = languages[language];
								if (!langData || !langData.examLinks[fileName]) {
									throw new Error(
										`Audio not available for ${language}/${fileName}`
									);
								}

								// Get the exam data object (which now contains both examAudio & markingScheme)
								const examData = langData.examLinks[fileName];
								if (!examData || !examData.examAudio) {
									throw new Error(
										`Audio not available for ${language}/${fileName}`
									);
								}
								// Set the audio element's source to the examAudio property
								audio.src = examData.examAudio;
								try {
									audio.load();
								} catch (err) {
									sectionsContainer.innerHTML = `<div class="text-center text-gray-700">Error loading audio data, Are you outside of Ireland? Due to SEC restrictions this site only works in Ireland. Sorry!</div>`;
								}

								// Update marking scheme buttons
								const markingSchemeContainer = document.getElementById(
									"markingSchemeContainer"
								);
								if (examData.markingScheme) {
									const markingScheme = examData.markingScheme;
									markingSchemeContainer.innerHTML = ""; // Clear any previous buttons

									if (markingScheme.ordinaryLevel) {
										const btnOrdinary = document.createElement("a");
										btnOrdinary.textContent = "Ordinary Level Marking Scheme";
										btnOrdinary.href = markingScheme.ordinaryLevel;
										btnOrdinary.className =
											" text-center m-[5px] py-[8px] px-[12px] border-0 bg-gray-200 text-gray-700 cursor-pointer hover:bg-gray-300 rounded-md border-2 border-green-300";
										// "px-4 py-2 bg-green-300 text-gray-800 rounded hover:bg-green-400";
										btnOrdinary.target = "_blank";
										markingSchemeContainer.appendChild(btnOrdinary);
									}

									if (markingScheme.higherLevel) {
										const btnHigher = document.createElement("a");
										btnHigher.textContent = "Higher Level Marking Scheme";
										btnHigher.href = markingScheme.higherLevel;
										btnHigher.className =
											// "px-4 py-2 bg-red-300 text-gray-800 rounded hover:bg-red-400";
											"text-center m-[5px] py-[8px] px-[12px] border-0 bg-gray-200 text-gray-700 cursor-pointer hover:bg-gray-300 rounded-md border-2 border-red-300";
										btnHigher.target = "_blank";
										markingSchemeContainer.appendChild(btnHigher);
									}
								} else {
									markingSchemeContainer.innerHTML = "";
								}

								// Update aural paper buttons
								const auralPaperContainer = document.getElementById(
									"auralPaperContainer"
								);
								auralPaperContainer.innerHTML = ""; // Clear any previous buttons

								if (examData.auralPaper) {
									const auralPaper = examData.auralPaper;
									if (auralPaper.ordinaryLevel) {
										const btnOrdinary = document.createElement("a");
										btnOrdinary.textContent = "📝 Ordinary Level Aural Paper";
										btnOrdinary.href = auralPaper.ordinaryLevel;
										btnOrdinary.className =
											"text-center m-[5px] py-[8px] px-[12px] border-0 bg-gray-200 text-gray-700 cursor-pointer hover:bg-gray-300 rounded-md border-2 border-green-300";
										btnOrdinary.target = "_blank";
										auralPaperContainer.appendChild(btnOrdinary);
									}
									if (auralPaper.higherLevel) {
										const btnHigher = document.createElement("a");
										btnHigher.textContent = "📝 Higher Level Aural Paper";
										btnHigher.href = auralPaper.higherLevel;
										btnHigher.className =
											"text-center m-[5px] py-[8px] px-[12px] border-0 bg-gray-200 text-gray-700 cursor-pointer hover:bg-gray-300 rounded-md border-2 border-red-300";
										btnHigher.target = "_blank";
										auralPaperContainer.appendChild(btnHigher);
									}
								} else {
									auralPaperContainer.innerHTML = "";
								}

								// Set up metadata listener before loading audio
								currentLoadedMetadataListener = () =>
									handleMetadataLoad(timestampData);
								audio.addEventListener(
									"loadedmetadata",
									currentLoadedMetadataListener,
									{ once: true }
								);

								return timestampData; // Pass the timestamp data through
							});
					})
					.catch((err) => {
						if (err.name === "AbortError") {
							console.log("Loading was cancelled");
							return;
						}
						console.error("Error in loadAudioData:", err);
						sectionsContainer.innerHTML = `<div class="text-center text-gray-700">⚠️ Error loading audio data, Are you outside of Ireland? Due to SEC restrictions this site only works in Ireland. Sorry!</div>`;
					})
					.finally(() => {
						if (currentAudioLoad?.signal === signal) {
							currentAudioLoad = null;
						}
					});
			}

			// --- Build UI on metadata load ---
			function handleMetadataLoad(data) {
				const totalDuration = audio.duration;
				const formatTime = (sec) => {
					const minutes = Math.floor(sec / 60);
					const seconds = Math.floor(sec % 60)
						.toString()
						.padStart(2, "0");
					return `${minutes}:${seconds}`;
				};
				timeDisplay.textContent = `0:00 / ${formatTime(totalDuration)}`;

				// Clear previous elements
				labelsContainer.innerHTML = "";
				sectionsContainer.innerHTML = "";
				sectionsBackground.innerHTML = "";

				let colorIndex = 0;
				const colors = [
					"rgba(255, 99, 132, 0.3)", // Light Red
					"rgba(54, 162, 235, 0.3)", // Light Blue
					"rgba(255, 206, 86, 0.3)", // Light Yellow
					"rgba(75, 192, 192, 0.3)", // Light Teal
					"rgba(153, 102, 255, 0.3)", // Light Purple
				];

				// Get language to determine how to handle sections
				const language = document.getElementById("languageSelector").value;

				// Handle different timestamp formats based on language
				let sectionKeys;
				if (language === "fr") {
					// For French, check if we have letter-based or number-based sections
					const hasLetterSections = Object.keys(data).some(
						(key) => key.startsWith("go to section") && /[a-e]$/i.test(key)
					);

					if (hasLetterSections) {
						// Use letter format
						sectionKeys = Object.keys(data).filter((label) =>
							label.startsWith("go to section")
						);
					} else {
						// Use number format - sort numerically
						sectionKeys = Object.keys(data)
							.filter((key) => !isNaN(parseInt(key)))
							.sort((a, b) => parseInt(a) - parseInt(b));
					}
				} else {
					// For German and other languages using numeric sections
					sectionKeys = Object.keys(data)
						.filter((key) => !isNaN(parseInt(key)))
						.sort((a, b) => parseInt(a) - parseInt(b));
				}

				sectionKeys.forEach((label, index) => {
					const sectionTime =
						language === "fr" && label.startsWith("go to section")
							? data[label]
							: data[label].seconds;

					const nextSectionTime = sectionKeys[index + 1]
						? language === "fr" &&
						  sectionKeys[index + 1].startsWith("go to section")
							? data[sectionKeys[index + 1]]
							: data[sectionKeys[index + 1]].seconds
						: totalDuration;

					const sectionWidth =
						((nextSectionTime - sectionTime) / totalDuration) * 100;
					const sectionLeft = (sectionTime / totalDuration) * 100;
					const sectionColor = colors[colorIndex % colors.length];

					// Get section label based on format
					let sectionLetter;
					if (language === "fr") {
						if (label.startsWith("go to section")) {
							sectionLetter = label.split(" ").pop().toUpperCase();
						} else {
							sectionLetter = label;
						}
					} else {
						sectionLetter = label;
					}
					colorIndex++;

					// Section background rectangle
					const sectionDiv = document.createElement("div");
					sectionDiv.className = "absolute top-0 h-full";
					sectionDiv.style.left = `${sectionLeft}%`;
					sectionDiv.style.width = `${sectionWidth}%`;
					sectionDiv.style.background = sectionColor;
					sectionsBackground.appendChild(sectionDiv);

					// Label above the progress bar
					const labelDiv = document.createElement("div");
					labelDiv.className = "absolute text-sm font-bold text-gray-900";
					labelDiv.style.left = `calc(${sectionLeft}% + 8px)`;
					labelDiv.style.top = "-18px";
					labelDiv.style.whiteSpace = "nowrap";
					labelDiv.style.zIndex = "10";
					labelDiv.textContent = sectionLetter;
					labelsContainer.appendChild(labelDiv);

					// Vertical line from label
					const lineDiv = document.createElement("div");
					lineDiv.className = "absolute bg-gray-900";
					lineDiv.style.width = "1px";
					lineDiv.style.height = "10px";
					lineDiv.style.left = `calc(${sectionLeft}% + 25px)`;
					lineDiv.style.top = "-8px";
					labelsContainer.appendChild(lineDiv);

					// Horizontal line connecting to vertical line
					const horizontalLineDiv = document.createElement("div");
					horizontalLineDiv.className = "absolute bg-gray-900";
					horizontalLineDiv.style.width = "5px";
					horizontalLineDiv.style.height = "1px";
					horizontalLineDiv.style.left = `calc(${sectionLeft}% + 20px)`;
					horizontalLineDiv.style.top = "-8px";
					labelsContainer.appendChild(horizontalLineDiv);

					// Create clickable section buttons
					const btn = document.createElement("button");
					btn.className =
						"m-[5px] py-[8px] px-[12px] border-0 bg-gray-200 text-gray-700 cursor-pointer hover:bg-gray-300 rounded-md";
					btn.textContent =
						language === "fr"
							? label.startsWith("go to section")
								? label
								: `Section ${label}`
							: `Section ${label}`;
					btn.addEventListener("click", () => {
						const jumpTime =
							language === "fr" && label.startsWith("go to section")
								? data[label]
								: data[label].seconds;
						audio.currentTime = jumpTime + 5;
						audio.play();
						playPauseBtn.textContent = "❚❚";
					});
					sectionsContainer.appendChild(btn);
				});
			}

			// Update language selector code - remove the querySelector lines and just keep the event listener
			const languageSelector = document.getElementById("languageSelector");

			// Add language change handler
			languageSelector.addEventListener("change", () => {
				const year = audioSelector.value;
				loadAudioData(year);
				onAudioChange();
			});

			// Update onAudioChange function
			function onAudioChange() {
				const language = document.getElementById("languageSelector").value;
				const languageNames = {
					fr: "French",
					de: "German",
					zh: "Chinese",
					it: "Italian",
					es: "Spanish",
				};
				const displayLanguage = languageNames[language] || language;
				document.title = `Aural Practice - ${displayLanguage} - ${audioSelector.value}`;
			}

			// --- Event Listeners ---
			audioSelector.addEventListener("change", (event) => {
				loadAudioData(event.target.value);
				onAudioChange();
			});
			function updateVolumeSliderBackground(slider) {
				const percentage = slider.value * 100;
				slider.style.background = `linear-gradient(to right, #000 0%, #000 ${percentage}%, #ccc ${percentage}%, #ccc 100%)`;
			}

			const volumeSlider = document.getElementById("volumeSlider");
			updateVolumeSliderBackground(volumeSlider);
			volumeSlider.addEventListener("input", (e) => {
				// If audio is muted and the slider value is increased above 0, unmute the audio
				if (audio.muted && e.target.value > 0) {
					audio.muted = false;
					// Change icon back to normal volume icon
					muteBtn.querySelector("img").src = "icons/volume-icon.svg";
				}
				audio.volume = e.target.value;
				updateVolumeSliderBackground(e.target);
			});
			const muteBtn = document.getElementById("muteBtn");
			muteBtn.addEventListener("click", () => {
				audio.muted = !audio.muted;
				if (audio.muted) {
					// Change icon to muted and update slider to reflect muted state
					muteBtn.querySelector("img").src = "icons/muted.svg";
					volumeSlider.value = 0;
					updateVolumeSliderBackground(volumeSlider);
				} else {
					// Change icon back to normal volume icon and restore volume (default to full volume)
					muteBtn.querySelector("img").src = "icons/volume-icon.svg";
					volumeSlider.value = 1;
					updateVolumeSliderBackground(volumeSlider);
				}
			});

			playPauseBtn.addEventListener("click", () => {
				if (audio.paused) {
					audio.play();
					// When audio plays:
					gtag("event", "audio_play", {
						event_category: "engagement",
						event_label: "Aural Practice",
					});
					playPauseBtn.textContent = "❚❚";
				} else {
					audio.pause();
					// When audio plays:
					gtag("event", "audio_pause", {
						event_category: "engagement",
						event_label: "Aural Practice",
					});
					playPauseBtn.textContent = "►";
				}
			});

			// Update progress bar & time display during playback
			audio.addEventListener("timeupdate", () => {
				if (audio.duration) {
					const percent = (audio.currentTime / audio.duration) * 100;
					progressBar.style.width = percent + "%";
					const formatTime = (sec) => {
						const minutes = Math.floor(sec / 60);
						const seconds = Math.floor(sec % 60)
							.toString()
							.padStart(2, "0");
						return `${minutes}:${seconds}`;
					};
					timeDisplay.textContent = `${formatTime(
						audio.currentTime
					)} / ${formatTime(audio.duration)}`;
				}
			});

			// Add these event listeners after the other progress bar code
			progressContainer.addEventListener("mousedown", startDragging);
			document.addEventListener("mousemove", drag);
			document.addEventListener("mouseup", stopDragging);
			progressContainer.addEventListener("touchstart", startDragging);
			document.addEventListener("touchmove", drag);
			document.addEventListener("touchend", stopDragging);

			// Add these functions to handle dragging
			function startDragging(e) {
				isDragging = true;
				progressContainer.style.cursor = "grabbing";
				// Prevent text selection while dragging
				document.body.style.userSelect = "none";
				// Initial drag position
				drag(e);
			}

			function drag(e) {
				if (!isDragging) return;

				e.preventDefault();
				const rect = progressContainer.getBoundingClientRect();
				let clientX;

				// Handle both mouse and touch events
				if (e.type === "touchmove") {
					clientX = e.touches[0].clientX;
				} else {
					clientX = e.clientX;
				}

				// Calculate position
				let position = (clientX - rect.left) / rect.width;
				position = Math.max(0, Math.min(1, position));

				// Update progress bar visually
				progressBar.style.width = `${position * 100}%`;

				// Update audio time
				if (audio.duration) {
					audio.currentTime = position * audio.duration;
				}
			}

			function stopDragging() {
				if (!isDragging) return;
				isDragging = false;
				progressContainer.style.cursor = "pointer";
				document.body.style.userSelect = "";
			}

			const speedSelector = document.getElementById("speedSelector");
			speedSelector.addEventListener("change", (e) => {
				audio.playbackRate = parseFloat(e.target.value);
			});

			// Reset play button on audio end
			audio.addEventListener("ended", () => {
				playPauseBtn.textContent = "►";
			});

			// Using localStorage for state persistence.
			function saveState() {
				const state = {
					language: languageSelector.value,
					file: audioSelector.value,
					progress: audio.currentTime,
					volume: volumeSlider.value,
					speed: speedSelector.value,
				};
				localStorage.setItem("auralsState", JSON.stringify(state));
			}

			// Restore state from localStorage.
			// Wait until the language and audio selectors have been populated.
			function restoreState() {
				const stateJson = localStorage.getItem("auralsState");
				if (stateJson) {
					try {
						const state = JSON.parse(stateJson);
						const languageSelector =
							document.getElementById("languageSelector");
						const audioSelector = document.getElementById("audioSelector");
						// If the selectors are not yet populated, try again shortly.
						if (
							!languageSelector.options.length ||
							!audioSelector.options.length
						) {
							setTimeout(restoreState, 100);
							return;
						}
						if (state.language) {
							languageSelector.value = state.language;
						}
						if (state.file) {
							audioSelector.value = state.file;
							// Load the audio data from the restored file (year) selection.
							loadAudioData(state.file);
							onAudioChange();
						} else {
							// If no file state is saved, load the default selection.
							loadAudioData(audioSelector.value);
							onAudioChange();
						}
						// After audio metadata loads, restore progress, volume, and playback speed.
						audio.addEventListener(
							"loadedmetadata",
							() => {
								if (state.progress) {
									audio.currentTime = state.progress;
								}

								// Restore volume.
								if (typeof state.volume !== "undefined") {
									volumeSlider.value = state.volume;
									audio.volume = state.volume;
									updateVolumeSliderBackground(volumeSlider);
								}

								// Restore playback speed.
								if (typeof state.speed !== "undefined") {
									let speedVal = parseFloat(state.speed);
									if (!isNaN(speedVal) && isFinite(speedVal)) {
										speedSelector.value = state.speed;
										audio.playbackRate = speedVal;
									} else {
										console.warn("Restored speed is invalid:", state.speed);
									}
								}
							},
							{ once: true }
						);
					} catch (err) {
						console.error("Error parsing local state:", err);
					}
				}
			}
			window.addEventListener("DOMContentLoaded", restoreState);
			// Save state before leaving the page.
			window.addEventListener("beforeunload", saveState);
		</script>
		<style>
			input[type="range"]::-webkit-slider-runnable-track {
				height: 4px;
				background: #000;
				border-radius: 20px;
			}

			input[type="range"]::-webkit-slider-thumb {
				-webkit-appearance: none;
				height: 10px;
				width: 10px;
				border-radius: 50%;
				/* background: #000; */
				border: 1px solid #000;
				background-color: #fff;
				margin-top: -3px; /* centers the thumb */
			}

			input[type="range"]::-moz-range-track {
				height: 4px;
				background: #000;
			}

			input[type="range"]::-moz-range-thumb {
				height: 10px;
				width: 10px;
				border-radius: 50%;
				background: #000;
			}

			#progressContainer {
				cursor: pointer;
			}
			#progressContainer:active {
				cursor: grabbing;
			}

			.site-heading {
				font-family: "VT323", monospace;
			}

			/* When hovering on any range input (e.g. volume slider), show pointer cursor */
			input[type="range"]:hover {
				cursor: pointer;
			}

			/* Disable tap highlight for marking scheme buttons on mobile */
			body {
				-webkit-tap-highlight-color: transparent;
				/* outline: none; optional, remove active outline */
			}
		</style>
	</body>
	<script>
		// Service Worker Registration
		if ("serviceWorker" in navigator) {
			window.addEventListener("load", async () => {
				try {
					const registration = await navigator.serviceWorker.register(
						"./sw.js",
						{
							scope: "./",
						}
					);
					console.log(
						"Service Worker registered with scope:",
						registration.scope
					);

					// Force update on each page load during development
					if (registration.installing) {
						console.log("Service worker installing");
					} else if (registration.waiting) {
						console.log("Service worker installed");
					} else if (registration.active) {
						console.log("Service worker active");
					}
				} catch (error) {
					console.error("Service Worker registration failed:", error);
				}
			});
		}
	</script>
</html>
